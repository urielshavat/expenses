<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>מנהל הוצאות</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Assistant', sans-serif;
            background-color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
        }

        .balance-container {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .balance-container:active {
            transform: scale(0.95);
            opacity: 0.7;
        }

        .card {
            background: #ffffff;
            border-radius: 1.25rem;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.06), 0 1px 2px -1px rgba(0, 0, 0, 0.06);
        }

        .input-field {
            border: 2px solid transparent;
            background-color: #f9fafb;
            transition: all 0.2s;
        }

        .input-field:focus {
            border-color: #3b82f6;
            background-color: #ffffff;
            outline: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade-in {
            animation: fadeIn 0.2s ease-out forwards;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: rgba(243, 244, 246, 0.95);
            backdrop-filter: blur(4px);
        }

        .chart-container {
            position: relative;
            height: 200px;
            width: 100%;
        }

        .budget-input {
            background: transparent;
            border-bottom: 1px dashed #e2e8f0;
            text-align: left;
            width: 65px;
            padding: 1px 4px;
        }

        .budget-input:focus {
            outline: none;
            border-bottom-color: #3b82f6;
            border-bottom-style: solid;
        }

        .name-input {
            background: transparent;
            border: none;
            width: 100%;
            font-weight: 600;
            color: #334155;
            padding: 1px 0;
        }

        .name-input:focus {
            outline: none;
            color: #3b82f6;
            border-bottom: 1px solid #3b82f6;
        }

        .btn-sync {
            background: #eff6ff;
            color: #2563eb;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 0.4rem 0.8rem;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            transition: all 0.2s;
        }

        .btn-sync:active {
            transform: scale(0.95);
        }

        .ltr-num {
            direction: ltr;
            display: inline-block;
        }

        .compact-tx {
            padding: 0.75rem 1rem !important;
            margin-bottom: 0.5rem !important;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <div class="w-full max-w-md bg-transparent flex flex-col min-h-screen">
        
        <!-- Top Toolbar -->
        <div class="flex justify-between items-center mb-4">
            <h1 id="pageTitle" class="text-lg font-bold text-slate-800 tracking-tight">מעקב הוצאות</h1>
            <div class="flex gap-0.5">
                <button onclick="window.toggleView()" class="text-slate-400 hover:text-slate-600 transition-colors p-2" title="עבור לתקציב">
                    <i id="viewIcon" class="fa-solid fa-wallet text-lg"></i>
                </button>
                <button onclick="window.toggleSettings()" class="text-slate-400 hover:text-slate-600 transition-colors p-2" title="הגדרות">
                    <i class="fa-solid fa-cog text-lg"></i>
                </button>
            </div>
        </div>

        <!-- Main Expense View -->
        <div id="mainView" class="view-content">
            <!-- Balance Header -->
            <header class="text-center mb-6 mt-2">
                <div id="balanceTrigger" class="balance-container cursor-pointer inline-flex flex-col items-center">
                    <p class="text-slate-500 text-xs mb-0.5 font-medium">מאזן נוכחי</p>
                    <div class="flex items-center gap-1.5">
                        <span id="balanceValue" class="text-5xl font-normal text-slate-900 tabular-nums ltr-num">0</span>
                        <span class="text-xl text-slate-400">₪</span>
                    </div>
                    <button class="mt-2 bg-white/60 backdrop-blur px-3 py-1 rounded-full text-blue-600 text-[10px] font-bold hover:bg-white transition-colors flex items-center gap-1.5 border border-slate-100">
                        <i id="refreshIcon" class="fa-solid fa-arrows-rotate"></i>
                        עדכן מאזן
                    </button>
                </div>
            </header>

            <!-- Main Form Card -->
            <section class="card p-4 mb-4">
                <form id="expenseForm" class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="relative">
                            <label class="block text-[10px] font-bold text-slate-400 mb-1 mr-1">כמות (₪)</label>
                            <input 
                                type="number" 
                                id="amountInput" 
                                step="any" 
                                inputmode="decimal"
                                placeholder="0" 
                                required
                                class="input-field w-full px-3 py-2.5 rounded-xl text-lg font-semibold text-slate-800"
                            >
                        </div>
                        <div class="relative">
                            <label class="block text-[10px] font-bold text-slate-400 mb-1 mr-1">שם ההוצאה</label>
                            <input 
                                type="text" 
                                id="nameInput" 
                                placeholder="סופר, דלק..." 
                                required
                                class="input-field w-full px-3 py-2.5 rounded-xl text-sm text-slate-800"
                            >
                        </div>
                    </div>
                    <button 
                        type="submit" 
                        id="submitBtn"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-md active:scale-[0.98] transition-all flex items-center justify-center gap-2 text-md"
                    >
                        <span id="btnText">הוסף הוצאה</span>
                        <i class="fa-solid fa-paper-plane text-xs"></i>
                    </button>
                </form>
            </section>

            <!-- Chart Section -->
            <section class="mb-6 card p-3">
                <h3 class="text-slate-800 text-xs font-bold mb-2 px-1 text-right opacity-70">7 ימים אחרונים</h3>
                <div class="chart-container">
                    <canvas id="expensesChart"></canvas>
                </div>
            </section>

            <!-- Summary Section -->
            <section class="flex flex-col pb-6">
                <div class="flex justify-between items-center mb-3 px-1">
                    <h3 class="text-slate-800 font-bold text-sm">הוצאות היום</h3>
                    <div class="text-slate-400 text-xs font-semibold">
                        ₪ <span id="todayTotal" class="text-slate-900 ltr-num text-sm">0</span>
                    </div>
                </div>

                <div id="transactionContainer" class="max-h-[400px] overflow-y-auto no-scrollbar mb-4">
                    <div id="transactionList" class="space-y-1"></div>
                </div>
            </section>
        </div>

        <!-- Budget View -->
        <div id="budgetView" class="view-content hidden">
            <!-- Budget Summary -->
            <div id="budgetSummary" class="card p-4 mb-4 border border-slate-200 bg-white">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-slate-500 text-[10px] font-bold uppercase tracking-widest">סיכום חודשי</h3>
                    <button onclick="window.fetchBudgetData()" class="btn-sync">
                        <i id="budgetRefreshIcon" class="fa-solid fa-arrows-rotate"></i>
                        סנכרן
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="bg-slate-50 p-2 rounded-xl border border-slate-100">
                        <p class="text-[9px] text-slate-400 mb-0.5 font-bold">הכנסות</p>
                        <p class="text-sm font-bold text-slate-800">₪ <span id="summaryTotalIncome" class="ltr-num">0</span></p>
                    </div>
                    <div class="bg-slate-50 p-2 rounded-xl border border-slate-100">
                        <p class="text-[9px] text-slate-400 mb-0.5 font-bold">הוצאות קבועות</p>
                        <p class="text-sm font-bold text-slate-800">₪ <span id="summaryTotalFixed" class="ltr-num">0</span></p>
                    </div>
                    <div class="bg-slate-50 p-2 rounded-xl border border-slate-100">
                        <p class="text-[9px] text-slate-400 mb-0.5 font-bold">הוצאות שנתיות (חודשי)</p>
                        <p class="text-sm font-bold text-slate-800">₪ <span id="summaryTotalAnnualMonthly" class="ltr-num">0</span></p>
                    </div>
                    <div class="bg-blue-50 p-2 rounded-xl border border-blue-100">
                        <p class="text-[9px] text-blue-600 mb-0.5 font-bold">תקציב נותר</p>
                        <p class="text-sm font-bold text-blue-700">₪ <span id="summaryRemaining" class="ltr-num">0</span></p>
                    </div>
                </div>

                <div class="pt-3 border-t border-slate-100">
                    <label class="block text-[9px] text-slate-400 mb-1 font-bold">תקציב חודשי מוגדר</label>
                    <div class="flex gap-2">
                        <input type="number" id="g4Input" class="input-field border-none rounded-lg px-3 py-1.5 flex-1 text-slate-800 font-bold text-xs" placeholder="0">
                        <button onclick="window.updateG4Budget()" class="bg-blue-600 px-3 py-1.5 rounded-lg text-[10px] font-bold text-white hover:bg-blue-700 transition-all">עדכן</button>
                    </div>
                </div>
            </div>

            <!-- Incomes -->
            <div class="mb-4">
                <h3 class="text-slate-800 font-bold text-xs mb-2 px-1 flex items-center gap-1.5">
                    <i class="fa-solid fa-circle-arrow-up text-green-500 text-[10px]"></i>
                    הכנסות
                </h3>
                <div id="incomeList" class="space-y-1.5"></div>
            </div>

            <!-- Fixed Monthly -->
            <div class="mb-4">
                <h3 class="text-slate-800 font-bold text-xs mb-2 px-1 flex items-center gap-1.5">
                    <i class="fa-solid fa-circle-arrow-down text-blue-500 text-[10px]"></i>
                    הוצאות קבועות
                </h3>
                <div id="fixedList" class="space-y-1.5"></div>
            </div>

            <!-- Annual -->
            <div class="mb-8">
                <h3 class="text-slate-800 font-bold text-xs mb-2 px-1 flex items-center gap-1.5">
                    <i class="fa-solid fa-calendar text-amber-500 text-[10px]"></i>
                    הוצאות שנתיות
                </h3>
                <div id="annualList" class="space-y-1.5"></div>
            </div>
        </div>
    </div>

    <!-- Settings Overlay -->
    <div id="settingsOverlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl transform translate-y-10 transition-transform duration-300" id="settingsContent">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-slate-900">הגדרות סנכרון</h2>
                <button onclick="window.toggleSettings()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 mb-1.5 mr-1 uppercase tracking-wider">Google Script ID</label>
                    <input type="password" id="sheetKeyInput" placeholder="Mck-LpZ123..." class="input-field w-full px-4 py-3 rounded-xl text-sm font-mono">
                </div>
                <button onclick="window.saveSettings()" class="w-full bg-slate-900 text-white font-bold py-3.5 rounded-xl active:scale-95 transition-all shadow-lg">שמור והתחבר</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation -->
    <div id="confirmOverlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl transform scale-95 transition-transform duration-300" id="confirmContent">
            <h3 class="text-md font-bold text-slate-900 mb-3 text-center">מחיקת הוצאה</h3>
            <p class="text-sm text-slate-500 mb-6 text-center">בטוח שברצונך למחוק הוצאה זו?</p>
            <div class="flex gap-2">
                <button onclick="window.confirmDeleteAction()" class="flex-1 bg-red-500 text-white font-bold py-3 rounded-xl shadow-md">מחק</button>
                <button onclick="window.closeConfirm()" class="flex-1 bg-slate-100 text-slate-700 font-bold py-3 rounded-xl">ביטול</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-5 py-2.5 rounded-full text-xs font-semibold shadow-2xl flex items-center gap-2.5 opacity-0 pointer-events-none transition-all duration-300 z-[100] w-[85%] max-w-xs">
        <i id="toastIcon" class="fa-solid fa-circle-info text-blue-400"></i>
        <span id="toastMessage" class="flex-1"></span>
    </div>

    <script>
        // Utilities
        function safeParseFloat(val) {
            if (val === null || val === undefined) return 0;
            if (typeof val === 'number') return val;
            const cleaned = val.toString().replace(/[\u200F\u00A0]/g, '').replace(/[^\d.-]/g, '');
            const num = parseFloat(cleaned);
            return isNaN(num) ? 0 : num;
        }

        /**
         * Calculates name cell as row - 1 in the same column.
         * E.g. Q3 -> Q2
         */
        function getNameCellFromValueCell(cell) {
            if (!cell) return '';
            const match = cell.match(/([A-Z]+)(\d+)/);
            if (!match) return '';
            const col = match[1];
            const row = parseInt(match[2], 10);
            return row > 1 ? col + (row - 1) : '';
        }

        async function fetchGAS(url, options = {}) {
            const fetchOptions = { ...options, mode: 'cors', redirect: 'follow' };
            try {
                const response = await fetch(url, fetchOptions);
                if (!response.ok) throw new Error(`Status: ${response.status}`);
                return response;
            } catch (error) {
                console.error('GAS Fetch Error:', error);
                throw error;
            }
        }

        // State
        let state = {
            sheetKey: localStorage.getItem('google_sheet_key') || '',
            balance: safeParseFloat(localStorage.getItem('cached_balance')) || 0,
            transactions: JSON.parse(localStorage.getItem('expense_history')) || [],
            budget: { incomes: [], fixed: [], annual: [], g4: 0 },
            currentView: 'main',
            isLoading: false,
            pendingDeleteRow: null,
            expandedSections: { incomeList: false, fixedList: false, annualList: false }
        };

        let expensesChart = null;

        const balanceDisplay = document.getElementById('balanceValue');
        const expenseForm = document.getElementById('expenseForm');
        const transactionList = document.getElementById('transactionList');
        const todayTotalDisplay = document.getElementById('todayTotal');
        const sheetKeyInput = document.getElementById('sheetKeyInput');
        const submitBtn = document.getElementById('submitBtn');
        const refreshIcon = document.getElementById('refreshIcon');
        const budgetRefreshIcon = document.getElementById('budgetRefreshIcon');

        function init() {
            render();
            if (!state.sheetKey) setTimeout(toggleSettings, 500);
            else fetchData();
            
            document.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.expense-delete-btn');
                if (deleteBtn) window.handleDelete(deleteBtn.getAttribute('data-row'));
            });
        }

        async function fetchData() {
            if (!state.sheetKey) return;
            setLoading(true);
            try {
                if (state.currentView === 'main') {
                    await fetchBalance();
                    await fetchTransactions();
                } else {
                    await fetchBudgetData();
                }
            } catch (err) { showToast('שגיאת סנכרון', 'exclamation'); }
            finally { setLoading(false); }
        }

        function toggleView() {
            const nextView = state.currentView === 'main' ? 'budget' : 'main';
            switchView(nextView);
        }

        async function switchView(view) {
            state.currentView = view;
            document.getElementById('mainView').classList.toggle('hidden', view !== 'main');
            document.getElementById('budgetView').classList.toggle('hidden', view !== 'budget');
            
            const viewIcon = document.getElementById('viewIcon');
            if (view === 'budget') {
                viewIcon.className = 'fa-solid fa-house text-lg';
                document.getElementById('pageTitle').innerText = 'ניהול תקציב';
                await fetchBudgetData();
            } else {
                viewIcon.className = 'fa-solid fa-wallet text-lg';
                document.getElementById('pageTitle').innerText = 'מעקב הוצאות';
                render();
            }
        }

        async function fetchBudgetData() {
            if (!state.sheetKey) return;
            setLoading(true);
            if (budgetRefreshIcon) budgetRefreshIcon.classList.add('animate-spin');
            
            const url = `https://script.google.com/macros/s/${state.sheetKey}/exec?action=getBudget`;
            try {
                const response = await fetchGAS(url);
                const data = await response.json();
                state.budget = {
                    incomes: data.income || data.incomes || [],
                    fixed: data.fixedMonthly || data.fixed || [],
                    annual: data.annual || [],
                    g4: data.currentMonthlyBudget || data.g4 || 0
                };
                renderBudget();
            } catch (err) { showToast('שגיאה בטעינת תקציב', 'exclamation'); }
            finally {
                if (budgetRefreshIcon) budgetRefreshIcon.classList.remove('animate-spin');
                setLoading(false);
            }
        }

        function renderBudget() {
            const b = state.budget;
            const incomes = Array.isArray(b.incomes) ? b.incomes : [];
            const fixed = Array.isArray(b.fixed) ? b.fixed : [];
            const annual = Array.isArray(b.annual) ? b.annual : [];
            
            const totalIncome = incomes.reduce((sum, item) => sum + safeParseFloat(item.value), 0);
            const totalFixed = fixed.reduce((sum, item) => sum + safeParseFloat(item.value), 0);
            const totalAnnual = annual.reduce((sum, item) => sum + safeParseFloat(item.value), 0);
            const totalAnnualMonthly = totalAnnual / 12;
            const remaining = totalIncome - totalFixed - totalAnnualMonthly;

            document.getElementById('summaryTotalIncome').innerText = Math.round(totalIncome).toLocaleString();
            document.getElementById('summaryTotalFixed').innerText = Math.round(totalFixed).toLocaleString();
            document.getElementById('summaryTotalAnnualMonthly').innerText = Math.round(totalAnnualMonthly).toLocaleString();
            document.getElementById('summaryRemaining').innerText = Math.round(remaining).toLocaleString();
            document.getElementById('g4Input').value = b.g4 || '';

            const renderList = (list, containerId) => {
                const container = document.getElementById(containerId);
                if (!container) return;
                container.innerHTML = '';
                
                if (list.length === 0) {
                    container.innerHTML = '<p class="text-[10px] text-slate-400 p-2 text-center opacity-50">אין פריטים</p>';
                    return;
                }

                const nonZero = list.filter(item => safeParseFloat(item.value) !== 0);
                const zeroItems = list.filter(item => safeParseFloat(item.value) === 0);
                const isExpanded = state.expandedSections[containerId];

                nonZero.forEach(item => container.appendChild(createBudgetItemEl(item)));

                if (zeroItems.length > 0) {
                    if (isExpanded) {
                        zeroItems.forEach(item => container.appendChild(createBudgetItemEl(item, true)));
                    }
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = 'w-full py-1.5 text-[10px] font-bold text-slate-400 hover:text-blue-500 transition-colors bg-slate-100/50 rounded-lg border border-dashed border-slate-200';
                    toggleBtn.innerText = isExpanded ? 'הסתר פריטים ריקים' : `הצג עוד ${zeroItems.length} סעיפים (₪0)`;
                    toggleBtn.onclick = () => {
                        state.expandedSections[containerId] = !isExpanded;
                        renderBudget();
                    };
                    container.appendChild(toggleBtn);
                }
            };

            renderList(incomes, 'incomeList');
            renderList(fixed, 'fixedList');
            renderList(annual, 'annualList');
        }

        function createBudgetItemEl(item, isZero = false) {
            const div = document.createElement('div');
            div.className = `bg-white px-3 py-2 rounded-xl flex justify-between items-center shadow-sm border border-slate-100 animate-fade-in gap-2 ${isZero ? 'opacity-60' : ''}`;
            
            const valueCell = item.cell || '';
            // If nameCell isn't provided, calculate it from valueCell (row-1)
            const nameCell = item.nameCell || getNameCellFromValueCell(valueCell);

            div.innerHTML = `
                <div class="flex-1">
                    <input type="text" class="name-input text-xs" 
                        value="${item.name || ''}" 
                        placeholder="שם הסעיף"
                        data-cell="${nameCell}"
                        data-type="name">
                </div>
                <div class="flex items-center gap-1">
                    <div class="relative">
                        <span class="absolute left-0 top-1/2 -translate-y-1/2 text-slate-400 text-[9px] ml-0.5">₪</span>
                        <input type="number" class="budget-input text-xs font-bold text-slate-900 pr-3" 
                            value="${item.value || 0}"
                            data-cell="${valueCell}"
                            data-type="value">
                    </div>
                    <button onclick="window.saveBudgetRow(this.closest('.animate-fade-in'))" class="text-blue-500 p-1.5 active:scale-75 transition-all" title="שמור">
                        <i class="fa-solid fa-check text-xs"></i>
                    </button>
                </div>
            `;
            return div;
        }

        async function saveBudgetRow(rowEl) {
            const nameInput = rowEl.querySelector('input[data-type="name"]');
            const valueInput = rowEl.querySelector('input[data-type="value"]');
            
            const nameCell = nameInput.dataset.cell;
            const valueCell = valueInput.dataset.cell;
            const nameVal = nameInput.value;
            const valueVal = valueInput.value;

            if (!state.sheetKey) return toggleSettings();
            
            setLoading(true);
            try {
                const promises = [];
                // 1. Always update name if cell is valid
                if (nameCell) {
                    promises.push(fetchGAS(`https://script.google.com/macros/s/${state.sheetKey}/exec?action=updateBudgetItem&cell=${nameCell}&value=${encodeURIComponent(nameVal)}`));
                }
                
                // 2. Always update value if cell is valid and distinct
                if (valueCell && valueCell !== nameCell) {
                    promises.push(fetchGAS(`https://script.google.com/macros/s/${state.sheetKey}/exec?action=updateBudgetItem&cell=${valueCell}&value=${encodeURIComponent(valueVal)}`));
                }
                
                await Promise.all(promises);
                showToast('הנתונים עודכנו בהצלחה', 'check');
                setTimeout(fetchBudgetData, 500);
            } catch (err) {
                showToast('עדכון נכשל', 'exclamation');
            } finally {
                setLoading(false);
            }
        }

        async function updateBudgetItem(cell, value) {
            if (!state.sheetKey || !cell) return;
            setLoading(true);
            try {
                await fetchGAS(`https://script.google.com/macros/s/${state.sheetKey}/exec?action=updateBudgetItem&cell=${cell}&value=${encodeURIComponent(value)}`);
                showToast('עודכן', 'check');
                setTimeout(fetchBudgetData, 400);
            } catch (err) { showToast('עדכון נכשל', 'exclamation'); }
            finally { setLoading(false); }
        }

        async function updateG4Budget() {
            await updateBudgetItem('G4', document.getElementById('g4Input').value);
        }

        function render() {
            if (state.currentView !== 'main') return;
            balanceDisplay.innerText = Math.round(state.balance).toLocaleString();
            
            const grouped = {};
            const todayStr = new Date().toLocaleDateString('en-GB');
            state.transactions.forEach(tx => {
                const date = tx.date || 'לא ידוע';
                if (!grouped[date]) grouped[date] = { items: [], total: 0 };
                const amount = Math.round(safeParseFloat(tx.amount));
                grouped[date].items.push({ ...tx, amountValue: amount });
                grouped[date].total += amount;
            });

            transactionList.innerHTML = '';
            const sortedDates = Object.keys(grouped).sort((a, b) => {
                const [da, ma, ya] = a.split('/').map(Number);
                const [db, mb, yb] = b.split('/').map(Number);
                return new Date(yb, mb - 1, db) - new Date(ya, ma - 1, da);
            });

            if (sortedDates.length === 0) {
                transactionList.innerHTML = `<div class="text-center py-10 text-slate-300"><p class="text-[10px] font-bold">אין הוצאות רשומות</p></div>`;
            } else {
                sortedDates.forEach(date => {
                    const group = grouped[date];
                    const header = document.createElement('div');
                    header.className = 'sticky-header py-1 px-1 text-[9px] font-bold text-slate-400 flex justify-between items-center tracking-wider';
                    header.innerHTML = `<span>${date === todayStr ? 'היום' : date}</span><span>₪${Math.round(group.total).toLocaleString()}</span>`;
                    transactionList.appendChild(header);
                    
                    group.items.forEach(tx => {
                        const div = document.createElement('div');
                        div.className = 'bg-white compact-tx rounded-xl flex justify-between items-center shadow-sm border border-slate-50 animate-fade-in group';
                        div.innerHTML = `
                            <div class="flex-1 flex flex-col">
                                <span class="font-bold text-slate-800 text-sm">${tx.name || 'הוצאה'}</span>
                                <span class="text-[9px] text-slate-400 uppercase">${tx.time || ''}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="text-red-500 font-bold tabular-nums ltr-num text-sm">₪${tx.amountValue.toLocaleString()}</div>
                                ${tx.row ? `<button data-row="${tx.row}" class="expense-delete-btn text-slate-200 hover:text-red-500 p-1.5 transition-colors"><i class="fa-solid fa-trash-can text-[10px]"></i></button>` : ''}
                            </div>`;
                        transactionList.appendChild(div);
                    });
                });
            }
            todayTotalDisplay.innerText = Math.round(grouped[todayStr]?.total || 0).toLocaleString();
            updateChart(grouped);
        }

        function updateChart(grouped) {
            const canvas = document.getElementById('expensesChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const hebrewDays = ['א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ש'];
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const dateStr = d.toLocaleDateString('en-GB'); 
                last7Days.push({ label: hebrewDays[d.getDay()], total: grouped[dateStr] ? Math.round(grouped[dateStr].total) : 0 });
            }
            if (expensesChart) expensesChart.destroy();
            expensesChart = new Chart(ctx, { 
                type: 'bar', 
                data: { 
                    labels: last7Days.map(d => d.label), 
                    datasets: [{ data: last7Days.map(d => d.total), backgroundColor: '#3b82f6', borderRadius: 4, barThickness: 20 }] 
                }, 
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: false, tooltip: { backgroundColor: '#1e293b', callbacks: { label: (c) => `₪${Math.round(c.parsed.y).toLocaleString()}` } } }, 
                    scales: { y: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { font: { size: 9 }, callback: v => Math.round(v) } }, x: { grid: { display: false }, ticks: { font: { size: 10, weight: 'bold' } } } } 
                } 
            });
        }

        async function fetchBalance() {
            if (!state.sheetKey) return;
            try {
                const response = await fetchGAS(`https://script.google.com/macros/s/${state.sheetKey}/exec?action=balance`);
                const data = await response.text();
                state.balance = safeParseFloat(data);
                localStorage.setItem('cached_balance', state.balance);
                render();
            } catch (err) {}
        }

        async function fetchTransactions() {
            if (!state.sheetKey) return;
            try {
                const response = await fetchGAS(`https://script.google.com/macros/s/${state.sheetKey}/exec?action=transactions`);
                const data = await response.json();
                if (Array.isArray(data)) {
                    state.transactions = data;
                    localStorage.setItem('expense_history', JSON.stringify(state.transactions));
                    render();
                }
            } catch (err) {}
        }

        async function handleAddExpense(e) {
            e.preventDefault();
            if (!state.sheetKey) return toggleSettings();
            setLoading(true);
            const amount = document.getElementById('amountInput').value;
            const name = document.getElementById('nameInput').value;
            const now = new Date();
            const time = now.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
            const date = now.toLocaleDateString('en-GB');
            try {
                await fetchGAS(`https://script.google.com/macros/s/${state.sheetKey}/exec?action=add&amount=${amount}&name=${encodeURIComponent(name)}&time=${time}&date=${date}`);
                expenseForm.reset();
                showToast('הוצאה נרשמה', 'check');
                await fetchData();
            } catch (err) { showToast('שגיאה בשמירה', 'exclamation'); } 
            finally { setLoading(false); }
        }

        function handleDelete(rowNumber) {
            state.pendingDeleteRow = rowNumber;
            const overlay = document.getElementById('confirmOverlay');
            overlay.classList.remove('hidden');
            setTimeout(() => { overlay.classList.add('opacity-100'); }, 10);
        }

        function closeConfirm() {
            const overlay = document.getElementById('confirmOverlay');
            overlay.classList.remove('opacity-100');
            setTimeout(() => { overlay.classList.add('hidden'); state.pendingDeleteRow = null; }, 300);
        }

        async function confirmDeleteAction() {
            if (!state.pendingDeleteRow) return;
            closeConfirm();
            setLoading(true);
            try {
                await fetchGAS(`https://script.google.com/macros/s/${state.sheetKey}/exec?action=delete&row=${state.pendingDeleteRow}`);
                showToast('הוצאה נמחקה', 'check');
                await fetchData();
            } catch (err) { showToast('מחיקה נכשלה', 'exclamation'); } 
            finally { setLoading(false); }
        }

        function setLoading(val) {
            state.isLoading = val;
            submitBtn.disabled = val;
            document.getElementById('btnText').innerText = val ? 'שולח...' : 'הוסף הוצאה';
            if (val) { refreshIcon?.classList.add('animate-spin'); submitBtn.classList.add('opacity-70'); }
            else { refreshIcon?.classList.remove('animate-spin'); submitBtn.classList.remove('opacity-70'); }
        }

        function toggleSettings() {
            const overlay = document.getElementById('settingsOverlay');
            if (overlay.classList.contains('hidden')) {
                sheetKeyInput.value = state.sheetKey;
                overlay.classList.remove('hidden');
                setTimeout(() => { overlay.classList.add('opacity-100'); }, 10);
            } else {
                overlay.classList.remove('opacity-100');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        }

        function saveSettings() {
            const key = sheetKeyInput.value.trim();
            if (!key) return showToast('הזן מזהה תקין', 'exclamation');
            state.sheetKey = key;
            localStorage.setItem('google_sheet_key', key);
            toggleSettings();
            showToast('הגדרות נשמרו', 'check');
            fetchData();
        }

        function showToast(msg, icon) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').innerText = msg;
            document.getElementById('toastIcon').className = `fa-solid fa-circle-${icon} text-blue-400`;
            toast.classList.remove('opacity-0', 'pointer-events-none');
            toast.classList.add('opacity-100');
            setTimeout(() => { toast.classList.add('opacity-0', 'pointer-events-none'); toast.classList.remove('opacity-100'); }, 3000);
        }

        window.toggleView = toggleView;
        window.fetchBudgetData = fetchBudgetData;
        window.updateBudgetItem = updateBudgetItem;
        window.saveBudgetRow = saveBudgetRow;
        window.updateG4Budget = updateG4Budget;
        window.handleDelete = handleDelete;
        window.confirmDeleteAction = confirmDeleteAction;
        window.closeConfirm = closeConfirm;
        window.toggleSettings = toggleSettings;
        window.saveSettings = saveSettings;
        window.fetchData = fetchData;

        document.getElementById('balanceTrigger').addEventListener('click', fetchData);
        expenseForm.addEventListener('submit', handleAddExpense);

        init();
    </script>
</body>
</html>
