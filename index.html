<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>מנהל הוצאות</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Assistant', sans-serif;
            background-color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
        }

        .balance-container {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .balance-container:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        .card {
            background: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        .input-field {
            border: 1px solid #e2e8f0;
            background-color: #f9fafb;
            transition: all 0.2s;
        }

        .input-field:focus {
            border-color: #3b82f6;
            background-color: #ffffff;
            outline: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade-in {
            animation: fadeIn 0.2s ease-out forwards;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: rgba(243, 244, 246, 0.95);
            backdrop-filter: blur(4px);
        }

        .chart-container {
            position: relative;
            height: 160px;
            width: 100%;
        }

        .budget-input {
            background: transparent;
            border-bottom: 1px dashed #e2e8f0;
            text-align: left;
            width: 65px;
            padding: 1px 4px;
        }

        .budget-input:focus {
            outline: none;
            border-bottom-color: #3b82f6;
            border-bottom-style: solid;
        }

        .name-input {
            background: transparent;
            border: none;
            width: 100%;
            font-weight: 600;
            color: #334155;
            padding: 1px 0;
        }

        .name-input:focus {
            outline: none;
            color: #3b82f6;
            border-bottom: 1px solid #3b82f6;
        }

        .btn-sync {
            background: #eff6ff;
            color: #2563eb;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 0.4rem 0.8rem;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            transition: all 0.2s;
        }

        .btn-sync:active {
            transform: scale(0.95);
        }

        .ltr-num {
            direction: ltr;
            display: inline-block;
        }

        .compact-tx {
            padding: 0.4rem 0.75rem !important;
            margin-bottom: 0.25rem !important;
        }

        .update-bar {
            position: sticky;
            bottom: 1rem;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            pointer-events: none;
            z-index: 40;
        }

        .update-btn {
            pointer-events: auto;
            background-color: #2563eb;
            color: white;
            font-weight: 800;
            padding: 0.75rem 2rem;
            border-radius: 9999px;
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.4);
            animation: slideUp 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .update-btn:active {
            transform: scale(0.95);
        }

        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <div class="w-full max-w-md bg-transparent flex flex-col min-h-screen">
        
        <!-- Top Toolbar -->
        <div class="flex justify-between items-center mb-3">
            <h1 id="pageTitle" class="text-md font-bold text-slate-800 tracking-tight">מעקב הוצאות</h1>
            <div class="flex gap-0.5">
                <button onclick="window.toggleView()" class="text-slate-400 hover:text-slate-600 transition-colors p-2" title="עבור לתקציב">
                    <i id="viewIcon" class="fa-solid fa-wallet text-base"></i>
                </button>
                <button onclick="window.toggleSettings()" class="text-slate-400 hover:text-slate-600 transition-colors p-2" title="הגדרות">
                    <i class="fa-solid fa-cog text-base"></i>
                </button>
            </div>
        </div>

        <!-- Main Expense View -->
        <div id="mainView" class="view-content">
            <!-- Balance Header -->
            <header class="mb-4">
                <div id="balanceTrigger" class="flex justify-between items-center bg-white/60 backdrop-blur p-3 rounded-2xl border border-slate-100 balance-container">
                    <div class="flex flex-col items-start">
                        <p class="text-slate-500 text-[10px] font-bold">מאזן נוכחי</p>
                        <div class="flex items-baseline gap-1">
                            <span id="balanceValue" class="text-2xl font-bold text-slate-900 ltr-num">0</span>
                            <span class="text-xs text-slate-400">₪</span>
                        </div>
                        <p class="text-[9px] text-slate-400 font-semibold">תקציב יומי: ₪ <span id="dailyBudgetValue" class="ltr-num">0</span></p>
                    </div>
                    <button onclick="window.fetchTransactionsOnly()" id="balanceRefreshBtn" class="bg-blue-600 text-white w-10 h-10 rounded-xl shadow-sm hover:bg-blue-700 transition-colors flex items-center justify-center">
                        <i id="refreshIcon" class="fa-solid fa-arrows-rotate text-sm"></i>
                    </button>
                </div>
            </header>

            <!-- Main Form Card -->
            <section class="card p-3 mb-4">
                <form id="expenseForm" class="flex gap-2 items-end">
                    <div class="flex-[1.5]">
                        <label class="block text-[9px] font-bold text-slate-400 mb-1 mr-1">כמות</label>
                        <input 
                            type="number" 
                            id="amountInput" 
                            step="any" 
                            inputmode="decimal"
                            placeholder="0" 
                            required
                            class="input-field w-full px-2 py-2 rounded-lg text-sm font-bold text-slate-800"
                        >
                    </div>
                    <div class="flex-[2.5]">
                        <label class="block text-[9px] font-bold text-slate-400 mb-1 mr-1">שם ההוצאה</label>
                        <input 
                            type="text" 
                            id="nameInput" 
                            placeholder="מה קנית?" 
                            required
                            class="input-field w-full px-2 py-2 rounded-lg text-sm text-slate-800"
                        >
                    </div>
                    <button 
                        type="submit" 
                        id="submitBtn"
                        class="bg-blue-600 text-white w-10 h-10 rounded-lg flex items-center justify-center active:scale-95 transition-all shadow-md"
                    >
                        <i id="submitIcon" class="fa-solid fa-plus text-sm"></i>
                    </button>
                </form>
            </section>

            <!-- Chart Section -->
            <section class="mb-4 card p-2">
                <div class="chart-container">
                    <canvas id="expensesChart"></canvas>
                </div>
            </section>

            <!-- Transaction List Section -->
            <section class="flex flex-col pb-6">
                <div id="transactionContainer" class="max-h-[500px] overflow-y-auto no-scrollbar">
                    <div id="transactionList" class="space-y-1"></div>
                </div>
            </section>
        </div>

        <!-- Budget View -->
        <div id="budgetView" class="view-content hidden">
            <!-- Budget Summary -->
            <div id="budgetSummary" class="card p-4 mb-4 border border-slate-200 bg-white">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="text-slate-500 text-[10px] font-bold uppercase tracking-widest">סיכום חודשי</h3>
                        <p class="text-[9px] text-slate-400 font-semibold" id="startDateDisplay">תאריך התחלה: --</p>
                    </div>
                    <button onclick="window.fetchBudgetData()" class="btn-sync">
                        <i id="budgetRefreshIcon" class="fa-solid fa-arrows-rotate"></i>
                        סנכרן
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="bg-slate-50 p-2 rounded-xl border border-slate-100">
                        <p class="text-[9px] text-slate-400 mb-0.5 font-bold">הכנסות</p>
                        <p class="text-sm font-bold text-slate-800">₪ <span id="summaryTotalIncome" class="ltr-num">0</span></p>
                    </div>
                    <div class="bg-slate-50 p-2 rounded-xl border border-slate-100">
                        <p class="text-[9px] text-slate-400 mb-0.5 font-bold">הוצאות קבועות</p>
                        <p class="text-sm font-bold text-slate-800">₪ <span id="summaryTotalFixed" class="ltr-num">0</span></p>
                    </div>
                    <div class="bg-slate-50 p-2 rounded-xl border border-slate-100">
                        <p class="text-[9px] text-slate-400 mb-0.5 font-bold">הוצאות שנתיות (חודשי)</p>
                        <p class="text-sm font-bold text-slate-800">₪ <span id="summaryTotalAnnualMonthly" class="ltr-num">0</span></p>
                    </div>
                    <div class="bg-blue-50 p-2 rounded-xl border border-blue-100">
                        <p class="text-[9px] text-blue-600 mb-0.5 font-bold">תקציב נותר</p>
                        <p class="text-sm font-bold text-blue-700">₪ <span id="summaryRemaining" class="ltr-num">0</span></p>
                    </div>
                </div>

                <div class="pt-3 border-t border-slate-100">
                    <label class="block text-[9px] text-slate-400 mb-1 font-bold">תקציב חודשי מוגדר</label>
                    <div class="flex gap-2">
                        <input type="number" id="g4Input" class="input-field border-none rounded-lg px-3 py-1.5 flex-1 text-slate-800 font-bold text-xs" placeholder="0">
                        <button id="g4UpdateBtn" onclick="window.updateG4Budget()" class="bg-blue-600 px-3 py-1.5 rounded-lg text-[10px] font-bold text-white hover:bg-blue-700 transition-all flex items-center justify-center min-w-[60px]">
                            <span id="g4BtnText">עדכן</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Incomes -->
            <div class="mb-4">
                <h3 class="text-slate-800 font-bold text-xs mb-2 px-1 flex items-center gap-1.5">
                    <i class="fa-solid fa-circle-arrow-up text-green-500 text-[10px]"></i>
                    הכנסות
                </h3>
                <div id="incomeList" class="space-y-1.5"></div>
            </div>

            <!-- Fixed Monthly -->
            <div class="mb-4">
                <h3 class="text-slate-800 font-bold text-xs mb-2 px-1 flex items-center gap-1.5">
                    <i class="fa-solid fa-circle-arrow-down text-blue-500 text-[10px]"></i>
                    הוצאות קבועות
                </h3>
                <div id="fixedList" class="space-y-1.5"></div>
            </div>

            <!-- Annual -->
            <div class="mb-8">
                <h3 class="text-slate-800 font-bold text-xs mb-2 px-1 flex items-center gap-1.5">
                    <i class="fa-solid fa-calendar text-amber-500 text-[10px]"></i>
                    הוצאות שנתיות
                </h3>
                <div id="annualList" class="space-y-1.5"></div>
            </div>

            <!-- Floating Update Button -->
            <div id="batchUpdateContainer" class="update-bar hidden">
                <button id="batchUpdateBtn" onclick="window.saveAllBudgetChanges()" class="update-btn">
                    <span id="batchBtnText">עדכן תקציב</span>
                    <i id="batchBtnIcon" class="fa-solid fa-cloud-arrow-up"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Overlay -->
    <div id="settingsOverlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl transform translate-y-10 transition-transform duration-300" id="settingsContent">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-slate-900">הגדרות סנכרון</h2>
                <button onclick="window.toggleSettings()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 mb-1.5 mr-1 uppercase tracking-wider">Google Script ID</label>
                    <div class="relative">
                        <input type="text" id="sheetKeyInput" placeholder="Mck-LpZ123..." class="input-field w-full px-4 py-3 rounded-xl text-sm font-mono">
                    </div>
                </div>
                <button onclick="window.saveSettings()" class="w-full bg-slate-900 text-white font-bold py-3.5 rounded-xl active:scale-95 transition-all shadow-lg text-xs">שמור והתחבר</button>
            </div>
        </div>
    </div>

    <!-- Advanced Update Modal (Retroactive Logic) -->
    <div id="advancedUpdateOverlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl transform scale-95 transition-transform duration-300" id="advancedUpdateContent">
            <h3 class="text-lg font-bold text-slate-900 mb-4 text-center">עדכון תקציב חודשי</h3>
            <p class="text-xs text-slate-500 mb-6 text-center leading-relaxed" id="advancedUpdateDesc">
                תאריך ההתחלה הנוכחי שונה מהיום. כיצד תרצה לעדכן את התקציב?
            </p>
            <div class="space-y-3">
                <button onclick="window.executeRetroactiveUpdate()" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-800 font-bold py-3.5 px-4 rounded-2xl flex flex-col items-center gap-1 transition-all">
                    <span class="text-sm">כן (רטרואקטיבי)</span>
                    <span class="text-[9px] font-normal text-slate-500 italic text-center">התקציב ישתנה אך התאריך יישאר זהה. המאזן יחושב מחדש רטרואקטיבית.</span>
                </button>
                <button onclick="window.executeFromTodayUpdate()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 px-4 rounded-2xl flex flex-col items-center gap-1 transition-all">
                    <span class="text-sm">לא (מהיום)</span>
                    <span class="text-[9px] font-normal text-white/80 italic text-center">תאריך ההתחלה יתעדכן להיום ותוזן הכנסת איזון עבור הימים שחלפו.</span>
                </button>
                <button onclick="window.closeAdvancedUpdate()" class="w-full bg-white text-slate-400 font-semibold py-2 rounded-xl text-xs">ביטול</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation -->
    <div id="confirmOverlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl transform scale-95 transition-transform duration-300" id="confirmContent">
            <h3 class="text-md font-bold text-slate-900 mb-3 text-center">מחיקת הוצאה</h3>
            <p class="text-sm text-slate-500 mb-6 text-center">בטוח שברצונך למחוק הוצאה זו?</p>
            <div class="flex gap-2">
                <button id="deleteConfirmBtn" onclick="window.confirmDeleteAction()" class="flex-1 bg-red-500 text-white font-bold py-3 rounded-xl shadow-md">מחק</button>
                <button onclick="window.closeConfirm()" class="flex-1 bg-slate-100 text-slate-700 font-bold py-3 rounded-xl">ביטול</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-5 py-2.5 rounded-full text-xs font-semibold shadow-2xl flex items-center gap-2.5 opacity-0 pointer-events-none transition-all duration-300 z-[100] w-[85%] max-w-xs">
        <i id="toastIcon" class="fa-solid fa-circle-info text-blue-400"></i>
        <span id="toastMessage" class="flex-1"></span>
    </div>

    <script>
        // Utilities
        function safeParseFloat(val) {
            if (val === null || val === undefined) return 0;
            if (typeof val === 'number') return val;
            const cleaned = val.toString().replace(/[\u200F\u00A0]/g, '').replace(/[^\d.-]/g, '');
            const num = parseFloat(cleaned);
            return isNaN(num) ? 0 : num;
        }

        function getTodayFormatted() {
            const d = new Date();
            const dd = String(d.getDate()).padStart(2, '0');
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const yyyy = d.getFullYear();
            return `${dd}/${mm}/${yyyy}`;
        }

        function parseLocalDate(dateStr) {
            if (!dateStr) return new Date();
            const parts = dateStr.split('/');
            if (parts.length !== 3) return new Date();
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1;
            const year = parseInt(parts[2], 10);
            return new Date(year, month, day);
        }

        function getNameCellFromValueCell(cell) {
            if (!cell) return '';
            const match = cell.match(/([A-Z]+)(\d+)/);
            if (!match) return '';
            const col = match[1];
            const row = parseInt(match[2], 10);
            return row > 1 ? col + (row - 1) : '';
        }

        function sanitizeScriptId(id) {
            if (!id) return '';
            const match = id.match(/\/macros\/s\/([^/]+)\/exec/);
            if (match) return match[1].trim();
            return id.trim();
        }

        async function fetchGAS(url, options = {}) {
            const fetchOptions = { 
                ...options, 
                mode: 'cors', 
                redirect: 'follow',
                cache: 'no-cache'
            };
            
            try {
                const response = await fetch(url, fetchOptions);
                if (!response.ok) {
                    throw new Error(`שגיאת HTTP: ${response.status}`);
                }
                return response;
            } catch (error) {
                console.error('GAS Fetch Error:', error);
                if (error instanceof TypeError && error.message === 'Failed to fetch') {
                    showToast('שגיאת חיבור: בדוק הרשאות סקריפט (Anyone) או חיבור אינטרנט.', 'triangle-exclamation');
                } else {
                    showToast(`שגיאה: ${error.message}`, 'circle-exclamation');
                }
                throw error;
            }
        }

        // State
        let state = {
            sheetKey: (localStorage.getItem('google_sheet_key') || '').trim(),
            balance: safeParseFloat(localStorage.getItem('cached_balance')) || 0,
            transactions: JSON.parse(localStorage.getItem('expense_history')) || [],
            budget: { incomes: [], fixed: [], annual: [], g4: 0, startDate: '' },
            currentView: 'main',
            isLoading: false,
            pendingDeleteRow: null,
            pendingG4Value: null,
            expandedSections: { incomeList: false, fixedList: false, annualList: false },
            dirtyBudgetItems: {} // Tracks cell: value for batch update
        };

        let expensesChart = null;

        const balanceDisplay = document.getElementById('balanceValue');
        const dailyBudgetValueDisplay = document.getElementById('dailyBudgetValue');
        const expenseForm = document.getElementById('expenseForm');
        const transactionList = document.getElementById('transactionList');
        const sheetKeyInput = document.getElementById('sheetKeyInput');
        const submitBtn = document.getElementById('submitBtn');
        const refreshIcon = document.getElementById('refreshIcon');
        const budgetRefreshIcon = document.getElementById('budgetRefreshIcon');
        const batchUpdateContainer = document.getElementById('batchUpdateContainer');

        function init() {
            logAnalytics();
            render();
            if (!state.sheetKey) {
                setTimeout(toggleSettings, 800);
            } else {
                fetchData();
            }
            
            document.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.expense-delete-btn');
                if (deleteBtn) window.handleDelete(deleteBtn.getAttribute('data-row'));
            });

            expenseForm.addEventListener('submit', handleAddExpense);
        }

        function logAnalytics() {
            try {
                const key = (localStorage.getItem('google_sheet_key') || 'unconfigured').trim();
                const platform = /iPhone|iPad|iPod/i.test(navigator.userAgent) ? 'iOS' : 'Web';
                const analyticsUrl = `https://script.google.com/macros/s/AKfycby4BicwiGGHaHUSxw1OQr1OTTg2xjMqpaGuTYIVP_rE-lxGLoGAsDVdAUWT6MfDtVinOQ/exec?userId=${encodeURIComponent(key)}&platform=${platform}`;
                
                // Fire and forget, silent background call
                fetch(analyticsUrl, { mode: 'no-cors', cache: 'no-cache' }).catch(() => {});
            } catch (e) {
                // Silently ignore any tracking failures
            }
        }

        async function fetchData() {
            if (!state.sheetKey) return toggleSettings();
            setLoading(true);
            try {
                await fetchBudgetData();
                await fetchTransactions();
            } catch (err) { }
            finally { setLoading(false); }
        }

        async function fetchTransactionsOnly() {
            if (!state.sheetKey) return toggleSettings();
            setLoading(true);
            try {
                await fetchTransactions();
            } catch (err) { }
            finally { setLoading(false); }
        }

        function toggleView() {
            const nextView = state.currentView === 'main' ? 'budget' : 'main';
            switchView(nextView);
        }

        async function switchView(view) {
            state.currentView = view;
            document.getElementById('mainView').classList.toggle('hidden', view !== 'main');
            document.getElementById('budgetView').classList.toggle('hidden', view !== 'budget');
            
            const viewIcon = document.getElementById('viewIcon');
            if (view === 'budget') {
                viewIcon.className = 'fa-solid fa-house text-base';
                document.getElementById('pageTitle').innerText = 'ניהול תקציב';
                await fetchBudgetData();
            } else {
                viewIcon.className = 'fa-solid fa-wallet text-base';
                document.getElementById('pageTitle').innerText = 'מעקב הוצאות';
                render();
            }
        }

        async function fetchBudgetData() {
            if (!state.sheetKey) return;
            const isBudgetView = state.currentView === 'budget';
            if (isBudgetView && budgetRefreshIcon) budgetRefreshIcon.classList.add('animate-spin');
            
            const url = `https://script.google.com/macros/s/${state.sheetKey}/exec?action=getBudget`;
            try {
                const response = await fetchGAS(url);
                const data = await response.json();
                state.budget = {
                    incomes: data.income || data.incomes || [],
                    fixed: data.fixedMonthly || data.fixed || [],
                    annual: data.annual || [],
                    g4: data.currentMonthlyBudget || data.g4 || 0,
                    startDate: data.startDate || ''
                };
                if (isBudgetView) renderBudget();
                else render();
            } catch (err) { }
            finally {
                if (isBudgetView && budgetRefreshIcon) budgetRefreshIcon.classList.remove('animate-spin');
            }
        }

        function handleBudgetInput(cell, value) {
            if (!cell) return;
            state.dirtyBudgetItems[cell] = value;
            updateBatchButtonVisibility();
        }

        function updateBatchButtonVisibility() {
            const hasChanges = Object.keys(state.dirtyBudgetItems).length > 0;
            batchUpdateContainer.classList.toggle('hidden', !hasChanges);
        }

        async function saveAllBudgetChanges() {
            if (Object.keys(state.dirtyBudgetItems).length === 0) return;
            if (!state.sheetKey) return toggleSettings();
            
            const btn = document.getElementById('batchUpdateBtn');
            const icon = document.getElementById('batchBtnIcon');
            const text = document.getElementById('batchBtnText');
            
            btn.disabled = true;
            text.innerText = 'מעדכן...';
            icon.className = 'fa-solid fa-spinner animate-spin';
            
            const updates = Object.entries(state.dirtyBudgetItems).map(([cell, value]) => ({ cell, value }));
            
            try {
                const url = `https://script.google.com/macros/s/${state.sheetKey}/exec?action=updateMultiple&data=${encodeURIComponent(JSON.stringify(updates))}`;
                await fetchGAS(url);
                
                showToast('התקציב עודכן בהצלחה', 'check');
                state.dirtyBudgetItems = {};
                updateBatchButtonVisibility();
                await fetchBudgetData();
            } catch (err) {
                showToast('עדכון נכשל', 'exclamation');
            } finally {
                btn.disabled = false;
                text.innerText = 'עדכן תקציב';
                icon.className = 'fa-solid fa-cloud-arrow-up';
            }
        }

        function renderBudget() {
            const b = state.budget;
            const incomes = Array.isArray(b.incomes) ? b.incomes : [];
            const fixed = Array.isArray(b.fixed) ? b.fixed : [];
            const annual = Array.isArray(b.annual) ? b.annual : [];
            
            const totalIncome = incomes.reduce((sum, item) => sum + safeParseFloat(item.value), 0);
            const totalFixed = fixed.reduce((sum, item) => sum + safeParseFloat(item.value), 0);
            const totalAnnual = annual.reduce((sum, item) => sum + safeParseFloat(item.value), 0);
            const totalAnnualMonthly = totalAnnual / 12;
            const remaining = totalIncome - totalFixed - totalAnnualMonthly;

            document.getElementById('summaryTotalIncome').innerText = Math.round(totalIncome).toLocaleString();
            document.getElementById('summaryTotalFixed').innerText = Math.round(totalFixed).toLocaleString();
            document.getElementById('summaryTotalAnnualMonthly').innerText = Math.round(totalAnnualMonthly).toLocaleString();
            document.getElementById('summaryRemaining').innerText = Math.round(remaining).toLocaleString();
            document.getElementById('g4Input').value = b.g4 || '';
            document.getElementById('startDateDisplay').innerText = `תאריך התחלה: ${b.startDate || '--'}`;

            const renderList = (list, containerId) => {
                const container = document.getElementById(containerId);
                if (!container) return;
                container.innerHTML = '';
                
                if (list.length === 0) {
                    container.innerHTML = '<p class="text-[10px] text-slate-400 p-2 text-center opacity-50">אין פריטים</p>';
                    return;
                }

                const nonZero = list.filter(item => safeParseFloat(item.value) !== 0);
                const zeroItems = list.filter(item => safeParseFloat(item.value) === 0);
                const isExpanded = state.expandedSections[containerId];

                nonZero.forEach(item => container.appendChild(createBudgetItemEl(item)));

                if (zeroItems.length > 0) {
                    if (isExpanded) {
                        zeroItems.forEach(item => container.appendChild(createBudgetItemEl(item, true)));
                    }
                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = 'w-full py-1.5 text-[10px] font-bold text-slate-400 hover:text-blue-500 transition-colors bg-slate-100/50 rounded-lg border border-dashed border-slate-200';
                    toggleBtn.innerText = isExpanded ? 'הסתר פריטים ריקים' : `הצג עוד ${zeroItems.length} סעיפים (₪0)`;
                    toggleBtn.onclick = () => {
                        state.expandedSections[containerId] = !isExpanded;
                        renderBudget();
                    };
                    container.appendChild(toggleBtn);
                }
            };

            renderList(incomes, 'incomeList');
            renderList(fixed, 'fixedList');
            renderList(annual, 'annualList');
            updateBatchButtonVisibility();
        }

        function createBudgetItemEl(item, isZero = false) {
            const div = document.createElement('div');
            div.className = `bg-white px-3 py-2 rounded-xl flex justify-between items-center shadow-sm border border-slate-100 animate-fade-in gap-2 ${isZero ? 'opacity-60' : ''}`;
            
            const valueCell = item.cell || '';
            const nameCell = item.nameCell || getNameCellFromValueCell(valueCell);

            div.innerHTML = `
                <div class="flex-1">
                    <input type="text" class="name-input text-xs" 
                        value="${item.name || ''}" 
                        placeholder="שם הסעיף"
                        oninput="window.handleBudgetInput('${nameCell}', this.value)">
                </div>
                <div class="flex items-center gap-1">
                    <div class="relative">
                        <span class="absolute left-0 top-1/2 -translate-y-1/2 text-slate-400 text-[9px] ml-0.5">₪</span>
                        <input type="number" class="budget-input text-xs font-bold text-slate-900 pr-3" 
                            value="${item.value || 0}"
                            oninput="window.handleBudgetInput('${valueCell}', this.value)">
                    </div>
                </div>
            `;
            return div;
        }

        async function updateG4Budget() {
            const newVal = document.getElementById('g4Input').value;
            if (!state.sheetKey) return toggleSettings();
            
            const todayStr = getTodayFormatted();
            const currentStart = state.budget.startDate;
            const oldBudget = safeParseFloat(state.budget.g4);

            if (!currentStart || currentStart === todayStr) {
                const btn = document.getElementById('g4UpdateBtn');
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner animate-spin"></i>';
                
                try {
                    await fetchGAS(`https://script.google.com/macros/s/${state.sheetKey}/exec?action=updateBudgetItem&cell=G4&value=${encodeURIComponent(newVal)}`);
                    showToast('עודכן', 'check');
                    await fetchBudgetData();
                } catch (err) {
                    showToast('עדכון נכשל', 'exclamation');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            } else {
                state.pendingG4Value = newVal;
                
                const todayDate = parseLocalDate(todayStr);
                const startDate = parseLocalDate(currentStart);
                const diffTime = Math.max(0, todayDate - startDate);
                const daysPassed = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                const oldDaily = oldBudget / 30;
                const adjustment = oldDaily * daysPassed;

                const descEl = document.getElementById('advancedUpdateDesc');
                if (descEl) {
                    descEl.innerHTML = `התקציב הישן (יומי: <b>${Math.round(oldDaily)}</b> ₪) יחושב עבור <b>${daysPassed}</b> ימים שחלפו, ותוזן הכנסת איזון של <b>${Math.round(adjustment)}</b> ₪ למאזן.`;
                }
                
                openAdvancedUpdate();
            }
        }

        function openAdvancedUpdate() {
            const overlay = document.getElementById('advancedUpdateOverlay');
            overlay.classList.remove('hidden');
            setTimeout(() => overlay.classList.add('opacity-100'), 10);
        }

        function closeAdvancedUpdate() {
            const overlay = document.getElementById('advancedUpdateOverlay');
            overlay.classList.remove('opacity-100');
            setTimeout(() => overlay.classList.add('hidden'), 300);
            state.pendingG4Value = null;
        }

        async function executeRetroactiveUpdate() {
            const val = state.pendingG4Value;
            closeAdvancedUpdate();
            setLoading(true);
            try {
                await fetchGAS(`https://script.google.com/macros/s/${state.sheetKey}/exec?action=updateBudgetItem&cell=G4&value=${encodeURIComponent(val)}`);
                showToast('עודכן רטרואקטיבית', 'check');
                await fetchData();
            } catch (err) {}
            finally { setLoading(false); }
        }

        async function executeFromTodayUpdate() {
            const newVal = state.pendingG4Value;
            const oldBudget = safeParseFloat(state.budget.g4);
            const todayStr = getTodayFormatted();
            const startStr = state.budget.startDate;

            const todayDate = parseLocalDate(todayStr);
            const startDate = parseLocalDate(startStr);
            const diffTime = Math.max(0, todayDate - startDate);
            const daysPassed = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            const oldDaily = oldBudget / 30;
            const adjustment = oldDaily * daysPassed;

            closeAdvancedUpdate();
            setLoading(true);
            try {
                const time = new Date().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
                await fetchGAS(`https://script.google.com/macros/s/${state.sheetKey}/exec?action=add&amount=${(-adjustment).toFixed(2)}&name=${encodeURIComponent('סגירת תקציב קודם')}&time=${time}&date=${todayStr}`);
                await fetchGAS(`https://script.google.com/macros/s/${state.sheetKey}/exec?action=updateBudgetItem&cell=G1&value=${encodeURIComponent(todayStr)}`);
                await fetchGAS(`https://script.google.com/macros/s/${state.sheetKey}/exec?action=updateBudgetItem&cell=G4&value=${encodeURIComponent(newVal)}`);
                showToast('התקציב עודכן ובוצע איזון', 'check');
                await fetchData();
            } catch (err) {
                showToast('עדכון נכשל', 'exclamation');
            } finally {
                setLoading(false);
            }
        }

        function render() {
            if (state.currentView !== 'main') return;
            balanceDisplay.innerText = Math.round(state.balance).toLocaleString();
            
            const dailyBudget = Math.round(safeParseFloat(state.budget.g4) / 30);
            if (dailyBudgetValueDisplay) {
                dailyBudgetValueDisplay.innerText = dailyBudget.toLocaleString();
            }
            
            const grouped = {};
            state.transactions.forEach(tx => {
                const date = tx.date || 'לא ידוע';
                if (!grouped[date]) grouped[date] = { items: [], total: 0 };
                const amount = Math.round(safeParseFloat(tx.amount));
                grouped[date].items.push({ ...tx, amountValue: amount });
                grouped[date].total += amount;
            });

            transactionList.innerHTML = '';
            const sortedDates = Object.keys(grouped).sort((a, b) => {
                const [da, ma, ya] = a.split('/').map(Number);
                const [db, mb, yb] = b.split('/').map(Number);
                return new Date(yb, mb - 1, db) - new Date(ya, ma - 1, da);
            });

            if (sortedDates.length === 0) {
                transactionList.innerHTML = `<div class="text-center py-10 text-slate-300"><p class="text-[10px] font-bold">אין הוצאות רשומות</p></div>`;
            } else {
                sortedDates.forEach(date => {
                    const group = grouped[date];
                    const header = document.createElement('div');
                    header.className = 'sticky-header py-1 px-1 text-[9px] font-bold text-slate-400 flex justify-between items-center tracking-wider';
                    header.innerHTML = `<span>${date}</span><span>₪${Math.round(group.total).toLocaleString()}</span>`;
                    transactionList.appendChild(header);
                    
                    group.items.forEach(tx => {
                        const div = document.createElement('div');
                        div.className = 'bg-white compact-tx rounded-xl flex justify-between items-center shadow-sm border border-slate-50 animate-fade-in group';
                        div.innerHTML = `
                            <div class="flex-1 flex flex-col">
                                <span class="font-bold text-slate-800 text-xs">${tx.name || 'הוצאה'}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="text-red-500 font-bold tabular-nums ltr-num text-xs">₪${tx.amountValue.toLocaleString()}</div>
                                ${tx.row ? `<button data-row="${tx.row}" class="expense-delete-btn text-slate-200 hover:text-red-500 p-1.5 transition-colors"><i class="fa-solid fa-trash-can text-[10px]"></i></button>` : ''}
                            </div>`;
                        transactionList.appendChild(div);
                    });
                });
            }
            updateChart(grouped);
        }

        function updateChart(grouped) {
            const canvas = document.getElementById('expensesChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const hebrewDays = ['א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ש'];
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const dateStr = d.toLocaleDateString('en-GB'); 
                last7Days.push({ label: hebrewDays[d.getDay()], total: grouped[dateStr] ? Math.round(grouped[dateStr].total) : 0 });
            }
            if (expensesChart) expensesChart.destroy();
            expensesChart = new Chart(ctx, { 
                type: 'bar', 
                data: { 
                    labels: last7Days.map(d => d.label), 
                    datasets: [{ data: last7Days.map(d => d.total), backgroundColor: '#3b82f6', borderRadius: 4, barThickness: 16 }] 
                }, 
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: false, tooltip: { backgroundColor: '#1e293b', callbacks: { label: (c) => `₪${Math.round(c.parsed.y).toLocaleString()}` } } }, 
                    scales: { y: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { font: { size: 8 }, callback: v => Math.round(v) } }, x: { grid: { display: false }, ticks: { font: { size: 9, weight: 'bold' } } } } 
                } 
            });
        }

        async function fetchTransactions() {
            if (!state.sheetKey) return;
            try {
                const response = await fetchGAS(`https://script.google.com/macros/s/${state.sheetKey}/exec?action=transactions`);
                const data = await response.json();
                
                if (data && typeof data === 'object') {
                    if ('balance' in data) {
                        state.balance = safeParseFloat(data.balance);
                        localStorage.setItem('cached_balance', state.balance);
                    }
                    if (Array.isArray(data.transactions)) {
                        state.transactions = data.transactions;
                        localStorage.setItem('expense_history', JSON.stringify(state.transactions));
                    }
                } else if (Array.isArray(data)) {
                    state.transactions = data;
                }
                render();
            } catch (err) {}
        }

        async function handleAddExpense(e) {
            e.preventDefault();
            if (!state.sheetKey) return toggleSettings();
            
            const amountInput = document.getElementById('amountInput');
            const nameInput = document.getElementById('nameInput');
            const amount = amountInput.value;
            const name = nameInput.value;

            if (!amount || !name) return;

            setLoading(true);
            const now = new Date();
            const time = now.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
            const date = now.toLocaleDateString('en-GB');
            
            try {
                await fetchGAS(`https://script.google.com/macros/s/${state.sheetKey}/exec?action=add&amount=${amount}&name=${encodeURIComponent(name)}&time=${time}&date=${date}`);
                expenseForm.reset();
                showToast('הוצאה נרשמה בהצלחה', 'check');
                await fetchTransactionsOnly();
            } catch (err) { 
                console.error('Error adding expense:', err);
            } finally { 
                setLoading(false); 
            }
        }

        function handleDelete(rowNumber) {
            state.pendingDeleteRow = rowNumber;
            const overlay = document.getElementById('confirmOverlay');
            overlay.classList.remove('hidden');
            setTimeout(() => { overlay.classList.add('opacity-100'); }, 10);
        }

        function closeConfirm() {
            const overlay = document.getElementById('confirmOverlay');
            overlay.classList.remove('opacity-100');
            setTimeout(() => { overlay.classList.add('hidden'); state.pendingDeleteRow = null; }, 300);
        }

        async function confirmDeleteAction() {
            if (!state.pendingDeleteRow) return;
            closeConfirm();
            setLoading(true);
            try {
                await fetchGAS(`https://script.google.com/macros/s/${state.sheetKey}/exec?action=delete&row=${state.pendingDeleteRow}`);
                showToast('הוצאה נמחקה', 'check');
                await fetchTransactionsOnly();
            } catch (err) { } 
            finally { setLoading(false); }
        }

        function setLoading(val) {
            state.isLoading = val;
            submitBtn.disabled = val;
            const refreshBtn = document.getElementById('balanceRefreshBtn');
            const refreshText = document.getElementById('refreshBtnText');
            
            if (val) {
                refreshIcon?.classList.add('animate-spin');
                submitBtn.classList.add('opacity-70');
                document.getElementById('submitIcon').className = 'fa-solid fa-spinner animate-spin text-sm';
                if (refreshBtn) refreshBtn.disabled = true;
            } else {
                refreshIcon?.classList.remove('animate-spin');
                submitBtn.classList.remove('opacity-70');
                document.getElementById('submitIcon').className = 'fa-solid fa-plus text-sm';
                if (refreshBtn) refreshBtn.disabled = false;
            }
        }

        function toggleSettings() {
            const overlay = document.getElementById('settingsOverlay');
            if (overlay.classList.contains('hidden')) {
                sheetKeyInput.value = state.sheetKey;
                overlay.classList.remove('hidden');
                setTimeout(() => { overlay.classList.add('opacity-100'); }, 10);
            } else {
                overlay.classList.remove('opacity-100');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        }

        function saveSettings() {
            const key = sanitizeScriptId(sheetKeyInput.value);
            if (!key) return showToast('הזן מזהה תקין', 'exclamation');
            state.sheetKey = key;
            localStorage.setItem('google_sheet_key', key);
            toggleSettings();
            showToast('הגדרות נשמרו', 'check');
            fetchData();
        }

        function showToast(msg, icon) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').innerText = msg;
            document.getElementById('toastIcon').className = `fa-solid fa-circle-${icon} text-blue-400`;
            toast.classList.remove('opacity-0', 'pointer-events-none');
            toast.classList.add('opacity-100');
            setTimeout(() => { toast.classList.add('opacity-0', 'pointer-events-none'); toast.classList.remove('opacity-100'); }, 5000);
        }

        window.toggleView = toggleView;
        window.fetchBudgetData = fetchBudgetData;
        window.updateG4Budget = updateG4Budget;
        window.handleDelete = handleDelete;
        window.confirmDeleteAction = confirmDeleteAction;
        window.closeConfirm = closeConfirm;
        window.toggleSettings = toggleSettings;
        window.saveSettings = saveSettings;
        window.fetchData = fetchData;
        window.fetchTransactionsOnly = fetchTransactionsOnly;
        window.executeRetroactiveUpdate = executeRetroactiveUpdate;
        window.executeFromTodayUpdate = executeFromTodayUpdate;
        window.closeAdvancedUpdate = closeAdvancedUpdate;
        window.handleBudgetInput = handleBudgetInput;
        window.saveAllBudgetChanges = saveAllBudgetChanges;

        init();
    </script>
</body>
</html>
